using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class TurnManager : MonoBehaviour
{
    public static TurnManager Instance;

    [Header("Danh sách người chơi")]
    public List<PlayerController> allPlayers = new List<PlayerController>();

    [Header("Trạng thái")]
    public int currentPlayerIndex = 0;
    private bool isGameInitialized = false;

    private void Awake()
    {
        if (Instance == null) Instance = this;
        else Destroy(gameObject);
    }

    private void Start()
    {
        StartCoroutine(InitializeGameSequence());
    }

    /// <summary>
    /// Khởi tạo trò chơi: Chờ bản đồ sinh xong, rồi bắt đầu lượt chơi
    /// </summary>
    private IEnumerator InitializeGameSequence()
    {
        Debug.Log("[TurnManager] Waiting for map generation...");

        // Chờ cho đến khi bản đồ sinh xong
        while (!MapManager.Instance.IsMapGenerated)
        {
            yield return new WaitForSeconds(0.1f);
        }

        Debug.Log("[TurnManager] Map generation complete! Initializing game...");

        // Bây giờ tìm tất cả Player
        PlayerController[] foundPlayers = FindObjectsOfType<PlayerController>();
        allPlayers.AddRange(foundPlayers);

        if (allPlayers.Count > 0)
        {
            Debug.Log($"[TurnManager] Found {allPlayers.Count} players. Starting first turn...");
            isGameInitialized = true;
            StartTurn(0);
        }
        else
        {
            Debug.LogError("[TurnManager] No players found in scene!");
        }
    }

    public void StartTurn(int playerIndex)
    {
        if (!isGameInitialized)
        {
            Debug.LogWarning("[TurnManager] Game not initialized yet!");
            return;
        }

        currentPlayerIndex = playerIndex;
        PlayerController activePlayer = allPlayers[currentPlayerIndex];

        Debug.Log($"[TurnManager] --- Lượt của: {activePlayer.characterData.characterName} ---");

        // 1. Reset bước di chuyển cho nhân vật đó
        activePlayer.StartTurn();

        // 2. Cập nhật UI hiển thị thông tin người đó
        PlayerStats stats = activePlayer.GetComponent<PlayerStats>();
        if (PlayerHUD.Instance != null)
        {
            PlayerHUD.Instance.UpdateHUD(stats);
        }

        // 3. Khóa di chuyển của những người KHÁC
        foreach (var p in allPlayers)
        {
            p.enabled = (p == activePlayer);
        }
    }

    public void EndCurrentTurn()
    {
        Debug.Log("[TurnManager] Kết thúc lượt!");

        // Chuyển sang người tiếp theo
        currentPlayerIndex++;

        if (currentPlayerIndex >= allPlayers.Count)
        {
            currentPlayerIndex = 0;
            Debug.Log("[TurnManager] >>> Bắt đầu vòng chơi mới! <<<");
        }

        StartTurn(currentPlayerIndex);
    }

    public bool IsGameInitialized => isGameInitialized;
}