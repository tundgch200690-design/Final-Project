using System.Collections;
using UnityEngine;

/// <summary>
/// Coordinates the game initialization sequence:
/// 1. Wait for MapManager to generate map with anchor rooms
/// 2. Wait for TurnManager to initialize players
/// 3. Signal game ready
/// </summary>
public class GameInitializer : MonoBehaviour
{
    [Header("Initialization")]
    [Tooltip("Show detailed logs during initialization")]
    public bool showDetailedLogs = true;

    private bool isGameReady = false;
    public bool IsGameReady => isGameReady;

    private void Start()
    {
        StartCoroutine(InitializeGameSequence());
    }

    private IEnumerator InitializeGameSequence()
    {
        Log("========== GAME INITIALIZATION START ==========");

        // ===== STEP 1: MAP GENERATION =====
        Log("STEP 1: Waiting for map generation from anchor rooms...");
        
        while (!MapManager.Instance.IsMapGenerated)
        {
            yield return new WaitForSeconds(0.1f);
        }

        int totalRooms = MapManager.Instance.GetTotalRoomsPlaced();
        int unusedTiles = MapManager.Instance.GetRemainingTiles();
        Log($"✓ Map generated successfully!");
        Log($"  - Rooms placed: {totalRooms}");
        Log($"  - Unused tiles: {unusedTiles}");

        // ===== STEP 2: WAIT FOR TURN MANAGER =====
        Log("STEP 2: Waiting for turn system to initialize...");

        while (!TurnManager.Instance.IsGameInitialized)
        {
            yield return new WaitForSeconds(0.1f);
        }

        Log($"✓ Turn system initialized!");
        Log($"  - Active players: {TurnManager.Instance.allPlayers.Count}");

        // ===== STEP 3: GAME READY =====
        Log("STEP 3: Finalizing game startup...");
        yield return new WaitForSeconds(0.5f); // Small delay for visual feedback

        isGameReady = true;
        Log("========== GAME READY TO PLAY! ==========");

        // Signal any listeners that game is ready
        OnGameReady();
    }

    private void OnGameReady()
    {
        // Here you can trigger UI transitions, fade in effects, etc.
        Debug.Log("[GameInitializer] Broadcasting game ready signal...");
        
        // Example: You could fade in the UI here
        // UIManager.Instance.FadeIn();
    }

    private void Log(string message)
    {
        if (showDetailedLogs)
        {
            Debug.Log($"[GameInitializer] {message}");
        }
    }
}
